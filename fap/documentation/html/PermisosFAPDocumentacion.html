<body>  <div id="container">    <div id="background"></div>    <table cellpadding="0" cellspacing="0">      <thead>        <tr>          <th class="docs">            <h1>            	<h2>              		PermisosFAPDocumentacion            	</h2>            </h1>          </th>          <th class="code">          </th>        </tr>      </thead>      <tbody>                                    <tr id="section-1">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-1">&#182;</a>              		</div>                 	<p>Permisos de administracion</p>            	 	</td>            	<td class="code">            		<pre>rule administrador<br/>when<br/>	agente.rolActivo = "administrador"<br/>then<br/>	grant<br/><br/>rule usuario<br/>when<br/>	agente.rolActivo = "usuario"<br/>then<br/>	grant<br/><br/>rule adminOrGestor<br/>when<br/>	agente.rolActivo = "administrador"<br/>	or agente.rolActivo = "gestor"<br/>then<br/>	grant<br/><br/>rule noUsuario<br/>when<br/>	agente.rolActivo = "usuario"<br/>then<br/>	deny<br/><br/><br/>rule logeado<br/>when <br/>	agente != null<br/>then <br/>	grant<br/><br/>rule noVisible<br/>when<br/>	agente != null or agente = null<br/>then<br/>	deny<br/>              		</pre>            	</td>          </tr>                            <tr id="section-2">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-2">&#182;</a>              		</div>                 	<p>Permisos de la pag presentacion</p>            	 	</td>            	<td class="code">            		<pre>rule presentacionPrepararParaFirmar<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(<br/>		action = "update" and<br/>		(agente.rolActivo in ("administrador", "usuario", "gestor")) and<br/>		solicitud.registro.fasesRegistro.borrador = "false"<br/>	)	<br/>	or<br/>	(<br/>		action = "read" and<br/>		(agente.rolActivo in ("administrador", "usuario"))<br/>	)	<br/>then<br/>	grant<br/><br/>rule presentacionModificar<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	action = "read"<br/>	or<br/>	(action = "update" and solicitud.registro.fasesRegistro.registro = "false")<br/>then<br/>	grant		<br/><br/>rule presentacionObtenerBorrador<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(agente.rolActivo in ("administrador", "usuario", "gestor"))<br/>	and<br/>	solicitud.registro.fasesRegistro.borrador = "true"<br/>then<br/>	grant<br/><br/><br/>rule presentacionFirmar<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(agente.rolActivo in ("administrador", "usuario", "gestor"))<br/>	and <br/>		solicitud.registro.fasesRegistro.borrador = "true"<br/>	and<br/>	(<br/>		(action = "update" and solicitud.registro.fasesRegistro.firmada= "false")<br/>		or	<br/>		(action = "read")<br/>	)	<br/>then<br/>	grant<br/><br/><br/><br/>rule presentacionRegistrar<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	solicitud.registro.fasesRegistro.firmada = "true"<br/>	and<br/>	(<br/>		(<br/>			action = "update"<br/>			and<br/>			(<br/>				(<br/>					agente.rolActivo = "usuario"<br/>					and<br/>					solicitud.registro.fasesRegistro.registro = "false"<br/>				)<br/>				or<br/>				(<br/>					agente.rolActivo in ("administrador", "gestor")<br/>					and<br/>					solicitud.registro.fasesRegistro.clasificarAed = "false"<br/>				)<br/>			)<br/>		)<br/>		or	<br/>			action = "read"<br/>	)<br/>then<br/>	grant			<br/><br/><br/>rule presentacionRecibo<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(agente.rolActivo in ("administrador", "usuario", "gestor"))<br/>	and<br/>	solicitud.registro.fasesRegistro.registro = "true"<br/>then<br/>	grant	<br/><br/><br/><br/>rule instruccion<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	solicitud.estado = "iniciada"<br/>then<br/>	grant		<br/><br/><br/>rule solicitudPreparadaFirmarYPresentar<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(action = "update" and<br/>	(agente.rolActivo in ("administrador", "usuario", "gestor")) and<br/>	solicitud.estado = "borrador" and<br/>	solicitud.registro.fasesRegistro.borrador = "true")<br/>	or<br/>	(action = "read" and<br/>	(agente.rolActivo in ("administrador", "usuario", "gestor")))<br/>then<br/>	grant<br/><br/>rule editableSiSolicitudIniciada<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	action = "update" and<br/>	solicitud.estado in ("Iniciada", "Requerida", "Requerida plazo vencido", "En verificación", "Pendiente requerimiento", "Excluido", "Plazo vencido", "Verificado")<br/>then<br/>	grant<br/><br/>rule solicitudPreparadaFirmar<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(action = "update" and<br/>	(agente.rolActivo in ("administrador", "usuario", "gestor")) and<br/>	solicitud.estado = "borrador"  and<br/>	solicitud.registro.fasesRegistro.borrador != null and<br/>	solicitud.registro.fasesRegistro.borrador = "true")<br/>	or<br/>	(action = "read" and<br/>	(agente.rolActivo in ("administrador", "usuario", "gestor")))<br/>then<br/>	grant<br/><br/>rule solicitudPreparadaPresentar<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(action = "update" and<br/>	(agente.rolActivo in ("administrador", "usuario", "gestor")) and<br/>	solicitud.estado = "borrador" and<br/>	solicitud.registro.fasesRegistro.borrador != null and<br/>	solicitud.registro.fasesRegistro.borrador = "true" and<br/>	solicitud.registro.fasesRegistro.firmada = "true")<br/>	or<br/>	(action = "read" and<br/>	(agente.rolActivo in ("administrador", "usuario", "gestor")))<br/>then<br/>	grant<br/>              		</pre>            	</td>          </tr>                            <tr id="section-3">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-3">&#182;</a>              		</div>                 	<p>Permiso lista de Solicitudes visibles para el usuario</p>            	 	</td>            	<td class="code">            		<pre>rule listaSolicitudes<br/>vars<br/>	SolicitudGenerica solicitud<br/>	Participacion participacion : sql("select p from Participacion p where p.agente=? AND p.solicitud=?", agente, solicitud)<br/>when<br/>	(action = "read" and agente.rolActivo in ("administrador", "gestor", "revisor"))<br/>	or<br/>	(<br/>	action = "read"<br/>	and<br/>	participacion != null 			<br/>	)<br/>then<br/>	grant<br/><br/>              		</pre>            	</td>          </tr>                            <tr id="section-4">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-4">&#182;</a>              		</div>                 	<p>Permisos pagina de presentacion</p>            	 	</td>            	<td class="code">            		<pre>              		</pre>            	</td>          </tr>                            <tr id="section-5">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-5">&#182;</a>              		</div>                 	            	 	</td>            	<td class="code">            		<pre>rule adminGestorRevisor<br/>when<br/>	(action in ("read", "update")) and <br/>	(agente.rolActivo in ("administrador", "gestor", "revisor"))<br/>then <br/>	grant<br/><br/>rule aportacion<br/>vars<br/>	SolicitudGenerica solicitud<br/>when <br/>	(agente.rolActivo in ("administrador", "usuario", "gestor", "revisor")) and<br/>	(solicitud.estado != "borrador")<br/>then <br/>	grant<br/><br/>rule aportacionDocumentos<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(action = "read") and <br/>	(agente.rolActivo in ("administrador", "usuario", "gestor", "revisor")) and<br/>	(solicitud.estado in ("iniciada", "requerida", "requerida plazo vencido", "excluido"))<br/>then<br/>	grant	<br/><br/>rule noEditable<br/>when<br/>	(action = "update")<br/>then<br/>	deny<br/><br/>rule noVisibleUsuario<br/>when<br/>	(action = "read") and<br/>	agente.rolActivo = "usuario"<br/>then<br/>	deny<br/><br/>rule solicitudEnBorrador<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	solicitud.estado = "borrador"	<br/>then<br/>	grant<br/><br/>              		</pre>            	</td>          </tr>                            <tr id="section-6">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-6">&#182;</a>              		</div>                 	<p>Este permiso lo tienen todas las páginas de la solicitud Controla que los datos no se puedan editar cuando la solicitud está preparada para registrar</p>            	 	</td>            	<td class="code">            		<pre>rule solicitudEditable<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(action = "read")<br/>	or<br/>	(agente.rolActivo in ("administrador", "gestor"))<br/>	or<br/>	(<br/>	 agente.rolActivo = "usuario"<br/>	 and<br/>	 solicitud.estado = "borrador"<br/>	 and<br/>	 solicitud.registro.fasesRegistro.borrador = "false"<br/>	)<br/>then<br/>	grant	<br/><br/><br/>rule solicitudEditableDocumentacion<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(agente.rolActivo in ("administrador", "gestor"))<br/>	or<br/>	(              		</pre>            	</td>          </tr>                            <tr id="section-7">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-7">&#182;</a>              		</div>                 	<p>agente.rolActivo = "usuario"</p>            	 	</td>            	<td class="code">            		<pre>	 usuario<br/>	 and<br/>	 solicitud.estado = "borrador"<br/>	 and<br/>	 solicitud.registro.fasesRegistro.borrador = "false"<br/>	)<br/>then<br/>	grant<br/><br/><br/>rule visibleSiAccesoCertificado<br/>when <br/>	agente.acceso = "certificado"<br/>then <br/>	grant<br/><br/><br/>rule visibleSiAccesoContrasena<br/>when <br/>	(agente.acceso = "usuario")<br/>then <br/>	grant<br/><br/><br/>rule documentoAutorizacionGenerado<br/>vars <br/>	SolicitudGenerica solicitud<br/>when <br/>	(solicitud.registro.autorizacionFuncionario.urlDescarga != null)<br/>	and<br/>	(agente.funcionario != "true")<br/>then <br/>	grant<br/><br/><br/>rule visibleFuncionarioAutorizado<br/>vars<br/>	SolicitudGenerica solicitud<br/>when <br/>	(agente.funcionario = "true")<br/>	and<br/>	(solicitud.solicitante.autorizaFuncionario = "true")<br/>then <br/>	grant<br/><br/>rule noVisibleFuncionarioAutorizado<br/>vars<br/>	SolicitudGenerica solicitud<br/>when <br/>	(agente.funcionario = "true")<br/>	and<br/>	(solicitud.solicitante.autorizaFuncionario = "true")<br/>then <br/>	deny<br/><br/>              		</pre>            	</td>          </tr>                            <tr id="section-8">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-8">&#182;</a>              		</div>                 	Se puede moficicar la aportación de documentación cuando está en borrador            	 	</td>            	<td class="code">            		<pre>rule aportacionModificar<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	solicitud.aportaciones.actual.estado in ("borrador")<br/>then<br/>	grant	<br/><br/>              		</pre>            	</td>          </tr>                            <tr id="section-9">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-9">&#182;</a>              		</div>                 	<p>/*   Cuando la firma y registro se quedo en un paso intermedio. Se le muestra un mensaje   al usuario diciendole que hubo un problema, que pulse otra vez el problema para   completar el registro  </p>            	 	</td>            	<td class="code">            		<pre>rule aportacionMensajeIntermedio<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	solicitud.aportaciones.actual.estado in ("firmada", "registrada", "clasificada", "finalizada")<br/>then<br/>	grant	<br/><br/>              		</pre>            	</td>          </tr>                            <tr id="section-10">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-10">&#182;</a>              		</div>                 	<p>/*   * Permisos de la pagina de presentacion  </p>            	 	</td>            	<td class="code">            		<pre>rule mensajeVerificacion<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(action = "read") and <br/>	(agente.rolActivo in ("administrador", "gestor", "revisor")) and<br/>	(solicitud.estado = "requerida plazo vencido")<br/>then<br/>	grant<br/><br/><br/>rule iniciarVerificacion<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(action in ("read", "update")) and <br/>	(agente.rolActivo in ("administrador", "gestor", "revisor")) and<br/>	(solicitud.estado = "iniciada") and<br/>	(solicitud.verificacion.estado != null and solicitud.verificacion.estado = "iniciada")<br/>then<br/>	grant<br/><br/>rule verificarTiposDocumentos<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(action in ("read", "update")) and <br/>	(agente.rolActivo in ("administrador", "gestor", "revisor")) and<br/>	(solicitud.estado != "borrador") and<br/>	(solicitud.verificacion.estado != null and solicitud.verificacion.estado = "verificandoTipos")<br/>then<br/>	grant<br/>              		</pre>            	</td>          </tr>                            <tr id="section-11">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-11">&#182;</a>              		</div>                 	<p>rule documentosNoVerificados vars SolicitudGenerica solicitud Documento documento : sql(&#8220;select d from Documento d where d.agente=? AND p.solicitud=?&#8221;, agente, solicitud) when (action in (&#8220;read&#8221;, &#8220;update&#8221;)) and  (agente.rolActivo in (&#8220;administrador&#8221;, &#8220;gestor&#8221;, &#8220;revisor&#8221;)) and (solicitud.estado = &#8220;iniciada&#8221;) and (solicitud.verificacion.) then grant</p>            	 	</td>            	<td class="code">            		<pre>              		</pre>            	</td>          </tr>                            <tr id="section-12">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-12">&#182;</a>              		</div>                 	            	 	</td>            	<td class="code">            		<pre>rule verificarDocumentos<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(agente.rolActivo in ("administrador", "gestor", "revisor")) and<br/>	(<br/>		(<br/>			(action = "read")<br/>			and (solicitud.estado != "borrador")<br/>			and solicitud.verificacion.estado != null<br/>			and solicitud.verificacion.estado = "enVerificacion"<br/>		)<br/>		or<br/>		(<br/>			(action = "update") and<br/>			(solicitud.estado != "borrador")<br/>			and solicitud.verificacion.estado != null<br/>			and solicitud.verificacion.estado = "enVerificacion" <br/>		)<br/>	)<br/>then <br/>	grant<br/><br/>rule verificacionRequerimientos<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(action in ("read", "update")) and <br/>	(agente.rolActivo in ("administrador", "gestor", "revisor")) and<br/>	(solicitud.estado in ("iniciada"))<br/>	and solicitud.verificacion.estado in ("enRequerimiento", "enRequerimientoFirmaSolicitada")<br/>then<br/>	grant<br/><br/>rule nuevoRequerimiento<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(action in ("read", "update")) and <br/>	(agente.rolActivo in ("administrador", "gestor", "revisor")) and<br/>	(solicitud.estado = "pendiente requerimiento")<br/>then<br/>	grant<br/><br/><br/>rule firmarRequerimiento<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(solicitud.estado = "iniciada") and<br/>	(solicitud.verificacion.estado != null)<br/>	and solicitud.verificacion.estado in ("enRequerimiento", "enRequerimientoFirmaSolicitada")<br/>	and<br/>	(<br/>		(<br/>			(action = "read") and <br/>			(agente.rolActivo in ("administrador", "gestor", "revisor"))		<br/>		)<br/>		or <br/>		(<br/>			(action = "update") and <br/>			(agente.rolActivo in ("administrador", "gestor"))		<br/>		)<br/>	)<br/>then<br/>	grant<br/><br/>rule finalizarRequerimiento<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(action in ("read", "update")) and <br/>	(agente.rolActivo in ("administrador", "gestor", "revisor")) and<br/>	(solicitud.estado in ("requerida", "requerida plazo vencido"))<br/>then<br/>	grant<br/><br/><br/>rule aportacionNoNull<br/>vars              		</pre>            	</td>          </tr>                            <tr id="section-13">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-13">&#182;</a>              		</div>                 	<p>TODO: Permitir variables con nombres tales como &#8220;documento&#8221;, .... etc</p>            	 	</td>            	<td class="code">            		<pre>	Documento doc<br/>when<br/>	doc.uri = null<br/>then<br/>	deny<br/><br/><br/><br/>rule nuevaSolicitud<br/>vars<br/>	Convocatoria convocatoria<br/>when<br/>	convocatoria.estado = "presentacion"<br/>then<br/>	grant<br/>              		</pre>            	</td>          </tr>                            <tr id="section-14">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-14">&#182;</a>              		</div>                 	<p>Baremación	</p>            	 	</td>            	<td class="code">            		<pre>rule listaEvaluaciones<br/>	when<br/>		agente.rolActivo in ("administrador", "gestor", "revisor")<br/>	then<br/>		grant<br/><br/><br/>rule evaluacion<br/>	when<br/>		agente.rolActivo in ("administrador", "gestor", "revisor")<br/>	then<br/>		grant<br/><br/><br/><br/>rule tableKeyOnlyEstadosSolicitud<br/>vars<br/>	TableKeyValue tableKeyValue<br/>when<br/>	tableKeyValue.table = "estadosSolicitud"<br/>	and<br/>	agente.rolActivo = "administrador"<br/>then<br/>	grant<br/><br/>rule tableKeyOnlyEstadosSolicitudUsuario<br/>vars<br/>	TableKeyValue tableKeyValue<br/>when<br/>	tableKeyValue.table = "estadosSolicitudUsuario"<br/>	and<br/>	agente.rolActivo = "administrador"<br/>then<br/>	grant<br/><br/>rule noHayVerificacionEnCurso<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(agente.rolActivo in ("administrador", "gestor", "revisor")) and (solicitud.verificacion.estado = null) <br/>then<br/>    grant<br/><br/>rule hayVerificacionEnCurso<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(agente.rolActivo in ("administrador", "gestor", "revisor")) and (solicitud.verificacion.estado != null) <br/>then<br/>    grant<br/><br/>rule verificacionConNuevosDoc<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(agente.rolActivo in ("administrador", "gestor", "revisor")) and (solicitud.verificacion.estado != null) and (solicitud.verificacion.estado = "enVerificacionNuevosDoc") <br/>then<br/>    grant<br/><br/>rule verificacionCrearRequerimiento<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(agente.rolActivo in ("administrador", "gestor", "revisor"))<br/>	and solicitud.verificacion.estado != null<br/>	and solicitud.verificacion.estado = "enRequerimientoSinRequerimiento"<br/>then<br/>	grant<br/><br/>rule solicitarFirmaRequerimiento<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(action = "update"<br/>	and (agente.rolActivo in ("administrador", "gestor", "revisor"))<br/>	and solicitud.verificacion.estado != null<br/>	and solicitud.verificacion.estado in ("enRequerimiento"))<br/>	or<br/>	(action = "read"<br/>	and (agente.rolActivo in ("administrador", "gestor", "revisor"))<br/>	and solicitud.verificacion.estado != null	<br/>	and solicitud.verificacion.estado in ("enRequerimiento", "enRequerimientoFirmaSolicitada"))<br/>then<br/>	grant<br/><br/>rule borradorRequerimiento<br/>vars<br/>	SolicitudGenerica solicitud<br/>when<br/>	(agente.rolActivo in ("administrador", "gestor", "revisor"))<br/>	and solicitud.verificacion.estado != null<br/>	and solicitud.verificacion.estado in ("enRequerimiento", "enRequerimientoFirmaSolicitada")<br/>then<br/>	grant<br/>              		</pre>            	</td>          </tr>                            <tr id="section-15">            	<td class="docs">              		<div class="pilwrap">                		<a class="pilcrow" href="#section-15">&#182;</a>              		</div>                 	<p>Permiso fantasma, ya que va a ser sobrescrito para su uso. Lo que en verdad está declarado no es lo que hace. Este permiso comprueba que no haya documentación nueva adjuntada por el solicitante y que no esté en la verificación actual.</p>            	 	</td>            	<td class="code">            		<pre>rule hayNuevaDocumentacionVerificacion<br/>when<br/>	agente.rolActivo != null<br/>then<br/>	grant<br/><br/>rule accederSiSolicituNoBorrador<br/>vars<br/>	SolicitudGenerica solicitud<br/>when <br/>	(agente.rolActivo in ("administrador", "usuario", "gestor", "revisor")) and<br/>	(solicitud.estado != "borrador")<br/>then <br/>	grant              		</pre>            	</td>          </tr>              </tbody>    </table>  </div>  <script>        	$('pre').addClass("prettyprint");	$('pre').css('overflow', 'auto');    prettyPrint();  </script></body>