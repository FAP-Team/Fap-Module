#{extends 'fap/template.html' /}
#{set title:'Ficha Evaluador' /}

%{
	def hasCriterios = !evaluacion.tipo.criterios.isEmpty()
	def hasCEconomicos = !evaluacion.tipo.ceconomicos.isEmpty()
}%

#{set 'menu'}
	<ul>
		<li><a href="@{fap.ConsultarEvaluacionesController.index}">Evaluaciones</a>
		<li><a href="#Evaluacion">Evaluacion</a></li>
		<li><a href="#Documentos">Documentos</a></li>		
	</ul>	
#{/set}

#{fap.messages /}

#{form @fap.FichaEvaluadorController.save(), class:'fichaEvaluador'}

<input type="hidden" name="evaluacion.id" value="${evaluacion.id}"/>

#{fap.grupo titulo:'Evaluación', id:'Evaluacion'}
	#{if evaluacion.tipo.comentariosAdministracion}
		#{simple.textarea name:'evaluacion.comentariosAdministracion', label:'Comentarios administración', value:messages.Messages.flashOrValue("evaluacion.comentariosAdministracion", evaluacion.comentariosAdministracion)/}
	#{/if}
	
	#{if evaluacion.tipo.comentariosSolicitante}
		#{simple.textarea name:'evaluacion.comentariosSolicitante', label:'Comentarios solicitante', value:messages.Messages.flashOrValue("evaluacion.comentariosSolicitante", evaluacion.comentariosSolicitante) /}
	#{/if}
	
	<div id="indice">
		#{if hasCriterios}
			<h2>Criterios de evaluacion</h2>
			<ul>
			#{list items:evaluacion.tipo.criterios, as:'tcriterio'}
				<li><a href="#criterio${tcriterio.jerarquia}">${tcriterio.jerarquia} - ${tcriterio.nombre}</a></li>	
			#{/list}
			</ul>	
		#{/if}
		
		#{if hasCEconomicos}
			<h2>Conceptos económicos</h2>
			<ul>
			#{list items:evaluacion.tipo.ceconomicos, as:'tceconomico'}
				<li><a href="#ceconomico${tceconomico.jerarquia}">${tceconomico.jerarquia} - ${tceconomico.nombre}</a></li>	
			#{/list}
			</ul>		
		#{/if}
	</div>
		
#{/fap.grupo}


<div id="Documentos"></div>

#{if hasCriterios}
	#{fap.grupo titulo:'Criterios de evaluación', id:'Criterios'}
	
	#{list items:evaluacion.criterios, as:'criterio'}
		%{
			def paramName  = "criterio[${criterio.id}]"
			def error = play.data.validation.Validation.errors(paramName + ".valor").join(",")  
			def valor = messages.Messages.flashOrValue(paramName + ".valor", criterio.valor)
			def comentariosAdministracion = messages.Messages.flashOrValue(paramName + ".comentariosAdministracion", criterio.comentariosAdministracion);
			def comentariosSolicitante = messages.Messages.flashOrValue(paramName + ".comentariosSolicitante", criterio.comentariosSolicitante);
		}%
		
		<div class="criterio" id="criterio${criterio.tipo.jerarquia}">
			<p class="nombre">${criterio.tipo.jerarquia} - ${criterio.tipo.nombre}</p>
			#{if criterio.tipo.descripcion != null}
				<div class="clearfix">
					<h3>Descripción</h3>
					<p>#{verbatim}${criterio.tipo.descripcion}#{/verbatim}</p>
				</div>
			#{/if}
			
			#{if criterio.tipo.instrucciones != null}
				<div class="clearfix">
					<h3>Instrucciones</h3> 
					<p>#{verbatim}${criterio.tipo.instrucciones}#{/verbatim}</p>
				</div>
			#{/if}
			
			#{if criterio.tipo.claseCriterio.equals("auto")}
				#{simple.uneditable label:'Valor', value:valor /}
			#{/if}

			#{elseif criterio.tipo.claseCriterio.equals("automod")}
				
			#{/elseif}
			
			#{elseif criterio.tipo.claseCriterio.equals("manual")}
				#{if criterio.tipo.tipoValor.equals('lista')}
					#{simple.select name:paramName + ".valor", label:'Valor', options:criterio.tipo.listaValores, optionsText:'descripcion', optionsValue:'valor', value:valor, error: error, showKeyInLabel: true/}
				#{/if}
				
				#{elseif criterio.tipo.tipoValor.equals('cantidad')}
					#{simple.text name:paramName + ".valor", label:'Valor', value:valor, error: error /}
				#{/elseif}
			#{/elseif}
			
			
			#{if criterio.tipo.comentariosAdministracion}
				#{simple.textarea name:paramName + ".comentariosAdministracion", label:'Comentarios administración', value: comentariosAdministracion /}
			#{/if}
			
			#{if criterio.tipo.comentariosSolicitante}
				#{simple.textarea name:paramName + ".comentariosSolicitante", label:'Comentarios solicitante', value: comentariosSolicitante /}
			#{/if}
		
		</div>	
	#{/list}
				
	#{/fap.grupo}
#{/if}

#{if  hasCEconomicos}
	#{fap.grupo titulo:'Conceptos económicos', id: 'CEconomicos'}
		
	#{list items:evaluacion.ceconomicos, as:'ceconomico'}
		%{
			def paramName  = "ceconomico[${ceconomico.id}]";
			def error = play.data.validation.Validation.errors(paramName + ".valor").join(",");  

			def newValue = {name, label, value -> [name : name, label : label, value : messages.Messages.flashOrValue(name, value), error : play.data.validation.Validation.errors(name).join(",")]}
			def valorSolicitado = newValue(paramName + ".valorSolicitado", "Valor Solicitado", ceconomico.valorSolicitado)
			def valorEstimado   = newValue(paramName + ".valorEstimado", "Valor Estimado", ceconomico.valorEstimado)
			
			def comentariosAdministracion = messages.Messages.flashOrValue(paramName + ".comentariosAdministracion", ceconomico.comentariosAdministracion);
			def comentariosSolicitante = messages.Messages.flashOrValue(paramName + ".comentariosSolicitante", ceconomico.comentariosSolicitante); 
		}%
		
		<div class="ceconomico" id="ceconomico${ceconomico.tipo.jerarquia}">
			<p class="nombre">${ceconomico.tipo.jerarquia} - ${ceconomico.tipo.nombre}</p>
			
			#{if criterio.tipo.descripcion != null}
				<div class="clearfix">
					<h3>Descripción</h3>
					<p>#{verbatim}${ceconomico.tipo.descripcion}#{/verbatim}</p>
				</div>
			#{/if}
			
			#{if criterio.tipo.instrucciones != null}
				<div class="clearfix">
					<h3>Instrucciones</h3>
					<p>#{verbatim}${ceconomico.tipo.instrucciones}#{/verbatim}</p>
				</div>
			#{/if}
			
			
			#{simple.uneditable label:valorSolicitado.label, value:valorSolicitado.value, error:valorSolicitado.error /}
			#{simple.text name:valorEstimado.name, label:valorEstimado.label, value:valorEstimado.value, error:valorEstimado.error /}
				
			#{if ceconomico.tipo.comentariosAdministracion}
				#{simple.textarea name:paramName + ".comentariosAdministracion", label:'Comentarios administración', value: comentariosAdministracion /}
			#{/if}
			
			#{if ceconomico.tipo.comentariosSolicitante}
				#{simple.textarea name:paramName + ".comentariosSolicitante", label:'Comentarios solicitante', value: comentariosSolicitante /}
			#{/if}
		</div>
		
	#{/list}
			
	#{/fap.grupo}
#{/if}

<div class="button_container">
	<input type="submit" class="boton" name="save" value="&{'baremacion.fichaevaluador.guardar'}">
	<input type="submit" class="boton" name="pdf" value="&{'baremacion.fichaevaluador.pdf'}">
	<input type="submit" class="boton" name="end" value="&{'baremacion.fichaevaluador.end'}">
</div>

#{/form}

<script>
Ext.onReady(function() {
	
	var data = [
		#{list items:documentos, as:'documento'}
			['${documento.tipo}', '${documento.descripcion}', '${documento.urlDescarga}']#{if !documento_isLast},#{/if}
		#{/list}
	];
	
    var store = Ext.create('Ext.data.ArrayStore', {
        fields: [
           {name: 'tipo'},
		   {name : 'descripcion'},
		   {name : 'urlDescarga'}
        ],
        data: data
    });
		    
    var boton_abrir = new Ext.Button({
    	text: 'Abrir',
    	disabled: true,
    	handler : function(){
    		var url = grid.getSelectionModel().getSelection()[0].data.urlDescarga;
    		window.open(url);
    	}
    });

   	var grid = new Ext.grid.GridPanel({
		store : store,
		columns : [
			{text:'Tipo', dataIndex:'tipo', sortable:true,width:200}, 
			{text:'Descripción',dataIndex:'descripcion', sortable:true, flex:true} 
		],
		renderTo: 'Documentos',
		height: 350,
		title: 'Documentos accesibles para la evaluación',
		dockedItems: [{
				itemId: 'barraInferior',
        		xtype: 'toolbar',
				dock: 'bottom',
				items: [{
						  itemId: 'searchbox',
        				  width: 300,
        				  fieldLabel: 'Buscar',
        				  labelWidth: 50,
        				  xtype: 'searchfield',
        				  store: store
    				     },'->', boton_abrir
				]
		}]
	});
	
	function selectionChange(){
		var hasSelection = grid.getSelectionModel().hasSelection();
    	boton_abrir.setDisabled(!hasSelection);
	}
	grid.addListener("selectionchange", selectionChange);
	selectionChange();
});
</script>