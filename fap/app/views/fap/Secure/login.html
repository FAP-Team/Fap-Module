#{extends 'fap/template.html' /}

#{set title:configfap.get('fap.app.name')/}

#{set 'cabeceraUsuario'}
	<p>&{'fap.login.welcome', configfap.get('fap.app.name')}</p>
#{/set}

%{
	showCert = configfap.getBoolean('fap.login.type.cert')
	showUser = configfap.getBoolean('fap.login.type.user')
	manualApp = configfap.get('fap.manual.aplicacion')
	if (manualApp == null)
	   manualApp = '#'
	else
	   manualApp = "/public/"+manualApp
%}


#{set 'moreScripts'}
	#{fap.platinojs /}
#{/set}

<div id="instrucciones" class="grid_6 alpha">
	#{include 'fap/Secure/instrucciones.html' /}
	#{include 'fap/Secure/help.html' /}	
</div>

<div class="grid_6 omega">

#{fap.messages}

#{if showCert}

	#{fap.grupo titulo:"Login"}
		#{form @authenticateCertificate(), id:"cert-form"}
			<input type="hidden" id="token" name="token" value="${token}"/>
			<input type="hidden" id="firma" name="firma" value=""/>
			<div class="form-row">
				<select id="certificado" name="certificado">
					<option disabled="disabled">--Certificados--</option>
				</select>
			</div>
			
			<div class="button_container">
				<input type="submit" id="loginsignin" value="&{'fap.login.signin'}" class="boton" />
			</div>
		#{/form}
		<div id="cert-msg"></div>
					
	#{/fap.grupo}
	
	<script>
		$(function(){
			var mensajes = new Mensajes("#cert-msg");
			Platino.listarCertificados("#certificado", {mensajes: mensajes});
						
			$('#cert-form').submit(function(e){
				$('#loginsignin').attr("disabled", "true");
				Platino.firmarTexto("#certificado", "#token", "#firma", {mensajes: mensajes});
				mensajes.loading("Comprobando certificado electrónico...");
			});
			
			mensajes.error("#{error 'login-certificado'/}");
		});
	</script>
#{/if}	
	
#{if showUser}
		#{fap.grupo titulo:"Acceso mediante usuario y contraseña"}

			%{
				def mostrarCaptcha = false
				if (session.get("accesoFallido") != null) {
					mostrarCaptcha = (new Integer(session.get("accesoFallido")) > 2)
				} 
			%}
			
			#{form @authenticate(), id:"authen-form"}
				<div class="form-row">
					<label for="username">&{'fap.login.username'}</label>
					<input type="text" name="username" id="login-username" value="${flash.username}" />
				</div>
				<div class="form-row">
					<label for="password">&{'fap.login.password'}</label>
					<input type="password" name="password" id="login-password" value="" />
				</div>
				
				#{if mostrarCaptcha == true}
                <div class="form-row">
					<p>#{ugot.recaptcha theme:"clean"/}</p>
				</div>
				#{/if}

                <div class="form-row">
					<div class="check">
                        <label for="remember">
						<input type="checkbox" name="remember" id="login-remember" ${flash.remember ? 'checked="true"' : ''} />
                        &{'fap.login.remember'}
						</label>
					</div>
				</div>

				<div class="button_container">
					<input class="boton" type="submit" id="signin" value="&{'fap.login.signin'}" />
				</div>
			#{/form}
			
			<script>
				$(function() {
					$('#authen-form').submit(function(e) {
						$('#signin').attr("disabled", "true");
					});
				});
			</script>
			
			
		#{/fap.grupo}	
#{/if}
	
#{/fap.messages}

</div>