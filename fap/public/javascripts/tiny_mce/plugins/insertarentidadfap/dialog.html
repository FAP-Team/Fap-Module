<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Insertar una entidad FAP</title>
	<script type="text/javascript" src="../../tiny_mce_popup.js"></script>
	<script type="text/javascript" src="js/dialog.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js" type="text/javascript"></script>
	<style>
	     body { padding:10px; }
         #breadcrumbs { font-size:0.9em; color:green; margin: 15px 0 15px 0; }
         #atributos { width: 80%; margin: 0 auto; padding:4px;}
         #leyenda { width: 80%; margin: 0 auto; padding:4px;}
         .celdaEntidad { width: 70%; }
         #atributos tr:hover { background: #C3F7A3; }
         .icono { float: right; }
         .insertarAliasAtributo { padding: 10px 0 10px 0; font-size: 1.1em; }
         .insertarAliasAtributo input { width: 200px; }
         .error { color: red; } 
    </style>
</head>


<body>

<script type="text/javascript">
    // *****************************************************************************************
    // Recogemos los datos del json devuelto por el controlador insertarImagen, para crear las <option> del <select>
    // *****************************************************************************************
    var idPlantilla = tinyMCEPopup.editor.plantillaEnEditor;
    $.getJSON(tinyMCE.settings.httpPath + '/plantillasdoccontroller/obtenerListaEntidades', {'idPlantilla' : idPlantilla}, function(data) {   
	   $.each(data, function(index,value) {
	          $('<option value="' + value +'">' + value + '</option>').insertAfter('#seleccion');
	   });  
	});
</script>

<form>
	<span>Escoja una entidad FAP a insertar:</span> 
	<select id="selectentidad">
        	<option id="seleccion" selected="selected" value="nooption">---</option>
	</select>
	
	<table id="leyenda">
	    <tr>
	        <td class="icono"><img src="img/insert.png" alt="Insertar atributo" /></td><td>Atributo</td>
	        <td class="icono"><img src="img/expand.png" alt="Expandir entidad" /></td><td>Entidad</td>
	        <td class="icono"><img src="img/list.png" alt="Lista" /></td><td>Lista</td>
	    </tr>
	</table>
</form>	


<script>
    // *****************************************************************************************
    // Función que recibe un json con los atributos de la entidad seleccionada y crea la lista 
    // *****************************************************************************************
    function obtenerAtributosEntidad(entidad) {
         $.getJSON(tinyMCE.settings.httpPath + '/plantillasdoccontroller/obtenerAtributosEntidad?entidad='+entidad, function(data) {
               var listaAtrib = '<table id="atributos">';
               if ($('#atributos').length)    
                   $("#atributos").remove();
               
               $.each(data, function(key, value) {
                       var entidad = $('#breadcrumbs').text().split(".")[0];
                       var idFila = "fila" + Math.floor((Math.random()*1000)+1); 
                       listaAtrib += '<tr id=\'' + idFila + '\'>';
                       if (typeof value.entidad !== "undefined") {               // es una entidad
                            listaAtrib += '<td class="celdaEntidad" onclick="expandirEntidad(\'' + value.nombre + '\',\'' + value.entidad + '\')">' + value.nombre + '</td>';
                            listaAtrib += '<td onclick="expandirEntidad(\'' + value.nombre + '\',\'' + value.entidad + '\')"><img src="img/expand.png" alt="Expandir entidad" /></td>';
                       }
                       
                       else if (typeof value.entidadLista !== "undefined") {      // es una entidad lista
                                listaAtrib += '<td class="celdaEntidad" onclick="insertarEntidadLista(\'' + value.nombre + '\',\'' + entidad + '\', \'' + value.entidadLista + '\', \'' + idFila + '\')">' + value.nombre + '</td>';
                                listaAtrib += '<td onclick="insertarEntidadLista(\'' + value.nombre + '\',\'' + entidad + '\', \'' + value.entidadLista + '\', \'' + idFila + '\')"><img src="img/list.png" alt="Insertar entidad lista" /></td>';
                       }
                       else {                                                    // es un atributo
                            listaAtrib += '<td class="celdaEntidad" onclick="insertarAtributo(\'' + value.nombre + '\', \'' + entidad + '\')">' + value.nombre + '</td>';
                            listaAtrib += '<td onclick="insertarAtributo(\'' + value.nombre + '\', \'' + entidad + '\')"><img src="img/insert.png" alt="Insertar atributo" /></td>';
                       }
                       listaAtrib += "</tr>";       	                       
               }); 
               listaAtrib += '</table>';
               $(listaAtrib).insertAfter('#breadcrumbs'); 
           });
    }
    
    // *****************************************************************************************
    // Expandimos la entidad seleccionada en nuestra lista
    // *****************************************************************************************    
    function expandirEntidad(nombre, entidad) {
        $('#breadcrumbs').append("." + nombre);
        obtenerAtributosEntidad(entidad);
    }

    // *****************************************************************************************
    // Retorna la ruta nuestro atributo FAP
    // *****************************************************************************************
    function getRutaAtributo(atributo, entidad) {
       // Insertamos el alias en vez del nombre real de la entidad
       var rutaAtributo = $('#breadcrumbs').text().split(".");
       rutaAtributo.shift();

       // Si la entidad seleccionada en el desplegable ya es un alias, no existe el componente #aliasEntidad
       var alias = "";
       if  ( $('#aliasEntidad').val() != undefined ) 
            alias = $('#aliasEntidad').val();
       else 
            alias = $.trim( $("#selectentidad").val().split("(")[0] );          // lo seleccionado en el desplegable ya es un alias

       // Si hay algo entre el nombre de la entidad/alias y el atributo. 
       // Un ejemplo sería "actual" en ${alegaciones.actual.estado}
       if (rutaAtributo.length)
           return ( alias + "." + rutaAtributo.join(".") + "." + atributo );

       return alias + "." + atributo;
    }
    
    // *****************************************************************************************
    // Insertamos en el editor el texto que corresponde a la identificación nuestro atributo FAP
    // *****************************************************************************************
    function insertarAtributo(atributo, entidad) {
       var rutaAtributo = getRutaAtributo(atributo, entidad);
       var guardarAlias = true;
       if ( $("#selectentidad").val().indexOf("(") != -1 )      // hemos seleccionado en el combo un alias
           guardarAlias = false;
           
       var alias = rutaAtributo.split(".")[0];
       
       if (alias)     // si el alias no es una cadena vacía    
            InsertarEntidadFAPDialog.insert(rutaAtributo, alias, entidad, guardarAlias);
       else {
            if ($('#errorAlias').length)
                $('#errorAlias').remove();   
            $('<p id="errorAlias" class="error">Debe escribir un alias</p>').insertBefore('#leyenda');
       }
    }
    
    // *****************************************************************************************
    // Concatenamos el alias del atributo en el código groovy que después inserta en el editor
    // *****************************************************************************************
    function insertarAtributoLista(atributo, entidad, entidadAtributo, idFila) {
        var rutaAtributo = getRutaAtributo(atributo, entidad);
        var aliasAtributo = $("#aliasAtributo" + idFila).val();
        var alias = $('#aliasEntidad').val();
	    var codigoGroovy = '#{list items:' + rutaAtributo + ', as:"' + aliasAtributo + '"} <br /><br /> #{/list}';
	    var guardarAlias = true;
	    if ( $("#selectentidad").val().indexOf("(") != -1 )      // hemos seleccionado en el combo un alias
	        guardarAlias = false;
	    console.log(guardarAlias);
	
	    if (!alias && guardarAlias) {     // si el alias es una cadena vacía (en el caso que no se seleccione un alias en el combo)    
            if ($('#errorAlias').length)
                $('#errorAlias').remove();   
            $('<p id="errorAlias" class="error">Debe escribir un alias</p>').insertBefore('#leyenda');
        }
        else {
	        if (aliasAtributo)
	            InsertarEntidadFAPDialog.insertLista(codigoGroovy, entidad, alias, aliasAtributo, entidadAtributo, guardarAlias);
	        else {
	            if ($('#errorAliasAtributo').length)
	                $('#errorAliasAtributo').remove();   
	            $('<p id="errorAliasAtributo" class="error">Debe escribir un alias</p>').insertBefore('#aliasAtributo' + idFila);
	        }
        }
    }
    // *****************************************************************************************
	// Insertamos la entidad lista, con su código groovy correspondiente
    // *****************************************************************************************
    function insertarEntidadLista(atributo, entidad, entidadAtributo, idFila) {   
        var llamadaFuncion = "insertarAtributoLista('" + atributo +  "', '" + entidad +  "', '" + entidadAtributo + "', '" + idFila + "');";
        var filaAlias = '<div class="insertarAliasAtributo"><input id="aliasAtributo' + idFila + '" type="text" /><br /><a href="#" onclick="' + 
                            llamadaFuncion +'">Insertar alias</a> de <strong>' + atributo + '</strong></div>';
        $("#" + idFila).after(filaAlias);
    }
    
    // *****************************************************************************************
	// Insertamos los atributos de la entidad seleccionada
    // *****************************************************************************************
    $("#selectentidad").change(function () {
           var valorSeleccionado = $(this).val();
           
           if ($('#breadcrumbs').length)       // si el nodo existe
                $('#breadcrumbs').remove();
           
           if ($('#alias').length)
                $('#alias').remove();

           // Si no es un alias, insertamos el input text para poder definir uno.
           // En la cadena del alias viene entre paréntesis la entidad a la que representan
           if (valorSeleccionado.indexOf("(") == -1) {                                          // no está presente el carácter "("
                $('<div id="breadcrumbs">' + valorSeleccionado + '</div>').insertAfter('#leyenda'); 
                $('<p id="alias">Alias de la entidad: <input type="text" id="aliasEntidad" size="35" value="' + valorSeleccionado.toLowerCase() + '" /></p>').insertBefore('#leyenda');
                $("select option:selected").each(function () {
                    obtenerAtributosEntidad(valorSeleccionado);
                });
           }
           else {                                                                               // alias
                var entidad = $.trim( valorSeleccionado.split("(")[1].split(")")[0] );
                $('<div id="breadcrumbs">' + entidad + '</div>').insertAfter('#leyenda'); 
                $('<p id="alias">Alias de la entidad <strong>' + entidad + '</strong></p>').insertBefore('#leyenda');
                $("select option:selected").each(function () {
                    obtenerAtributosEntidad(entidad);
                });
           }
     });
</script>


</body>
</html>
